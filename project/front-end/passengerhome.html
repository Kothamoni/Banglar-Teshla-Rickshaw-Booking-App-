<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Passenger Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
</head>
<body class="bg-gradient-to-br from-blue-200 to-purple-500 text-gray-900">

<!-- Navbar -->
<nav class="flex justify-between items-center p-6 bg-white shadow-md">
  <div class="text-2xl font-bold text-blue-800">
    Welcome, <span id="passengerName">Passenger</span> Dashboard
  </div>
  <a href="/front-end/login.html" onclick="logout()" class="text-blue-600 hover:text-red-800 text-2xl font-bold flex items-center gap-2">
    Logout
  </a>
</nav>

<!-- Grid Layout -->
<div class="grid grid-cols-1 lg:grid-cols-12 gap-6 p-6">

  <!-- LEFT: Profile -->
  <aside class="bg-white rounded-xl shadow-lg p-6 space-y-4 lg:col-span-3">
    <h2 class="text-2xl font-bold mb-4 text-center">üë§ Your Info</h2>
    <div class="space-y-3">
      <label class="block font-semibold">Name</label>
      <input id="pName" type="text" class="w-full p-2 border rounded" />

      <label class="block font-semibold">Phone</label>
      <input id="pPhone" type="text" class="w-full p-2 border rounded" />

      <label class="block font-semibold">Location</label>
      <input id="pLocation" type="text" class="w-full p-2 border rounded" />

      <label class="block font-semibold">Profile Photo URL (optional)</label>
      <input id="pPhoto" type="text" class="w-full p-2 border rounded" placeholder="Paste image URL here" />

      <label class="block font-semibold">Or Upload Profile Photo</label>
      <input id="pPhotoFile" type="file" accept="image/*" class="w-full p-2 border rounded" />

      <img id="profileImg" src="/front-end/image/default.png" class="w-32 h-32 object-cover mx-auto rounded-full border mt-4" alt="Profile" />

      <button onclick="updateProfile()" class="mt-4 w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">
        üíæ Save Updates
      </button>
    </div>
  </aside>

  <!-- MIDDLE: Rickshaw Booking -->
  <main class="lg:col-span-5">
    <div class="w-full bg-white rounded-2xl p-10 shadow-xl hover:shadow-2xl transition-shadow">
      <h2 class="text-5xl font-extrabold text-blue-800 mb-6 text-center">üöñ BOOK A RICKSHAW</h2>
      <img src="/front-end/image/passemgP.jpg" alt="Rickshaw" class="w-full h-auto mb-8 rounded-lg border border-gray-300">

      <div class="space-y-8 text-2xl">
        <div class="flex gap-6">
          <div class="w-1/2">
            <label class="block mb-2 font-semibold">From</label>
            <select id="selectFrom" class="w-full p-4 border rounded-xl shadow-sm">
              <option selected>BUP</option>
              <option>NDC</option>
              <option>Osman Hall</option>
              <option>Sagufta</option>
              <option>Mirpur-12</option>
              <option>Pallabi</option>
              <option>Mirpur-11</option>
              <option>Mirpur-10</option>
              <option>Keyari Moon</option>
              <option>Ideal School</option>
            </select>
          </div>
          <div class="w-1/2">
            <label class="block mb-2 font-semibold">To</label>
            <select id="selectTo" class="w-full p-4 border rounded-xl shadow-sm">
              <option selected>Mirpur-12</option>
              <option>BUP</option>
              <option>NDC</option>
              <option>Osman Hall</option>
              <option>Sagufta</option>
              <option>Pallabi</option>
              <option>Mirpur-11</option>
              <option>Mirpur-10</option>
              <option>Keyari Moon</option>
              <option>Ideal School</option>
            </select>
          </div>
        </div>

        <div class="flex gap-6">
          <div class="w-1/2">
            <label class="block mb-2 font-semibold">Date</label>
            <input type="date" id="rideDate" class="w-full p-4 border rounded-xl shadow-sm" required />
          </div>
          <div class="w-1/2">
            <label class="block mb-2 font-semibold">Time</label>
            <input type="time" id="rideTime" class="w-full p-4 border rounded-xl shadow-sm" required />
          </div>
        </div>

        <button onclick="goToBargaining()" class="w-full mt-6 bg-blue-600 hover:bg-blue-700 text-white text-3xl font-bold p-4 rounded-xl transition-all shadow-md hover:scale-105">
          üîç Search Rickshaws
        </button>
      </div>
    </div>
  </main>

  <!-- RIGHT: Weather + Traffic -->
  <aside class="space-y-8 lg:col-span-4">
    <div class="h-[300px]">
      <iframe src="https://www.accuweather.com/en/bd/dhaka/28143/weather-forecast/28143"
        class="w-full h-full rounded-xl shadow-lg" frameborder="0"></iframe>
    </div>
    <div class="h-[300px]">
      <iframe src="https://www.google.com/maps/embed?pb=!1m14!1m12!1m3!1d3649.7300379748387!2d90.3650598!3d23.8174704!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!5e0!3m2!1sen!2sbd!4v1687439156173!5m2!1sen!2sbd"
        class="w-full h-full rounded-xl shadow-lg" allowfullscreen="" loading="lazy"></iframe>
    </div>
  </aside>
</div>

<!-- Footer -->
<footer class="mt-16 bg-purple-300 text-white text-4xl text-center py-8">
  <p class="text-sm">¬© 2025 Banglar Tesla. All rights reserved.</p>
  <p class="text-xs mt-1">Designed with ‚ù§Ô∏è in Bangladesh</p>
</footer>

<script>
  const name = localStorage.getItem("name");
  const token = localStorage.getItem("token");
  const email = localStorage.getItem("email")?.toLowerCase();

  if (!token || !email) {
    alert("Please login first!");
    window.location.href = "/front-end/login.html";
  }

  document.getElementById("passengerName").innerText = name || "Passenger";

  async function fetchProfile() {
  try {
    const res = await fetch(`http://localhost:3000/api/passenger/${email}`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const data = await res.json();

    if (res.ok) {
      document.getElementById("pName").value = data.name || "";
      document.getElementById("pPhone").value = data.phone || "";
      document.getElementById("pLocation").value = data.address || "";  // your schema uses 'address' not 'location'
      document.getElementById("pPhoto").value = data.profilePic || "";

      const photoUrl = data.profilePic
        ? `http://localhost:3000/uploads/${data.profilePic}`
        : '/front-end/image/default.png';
      document.getElementById('profileImg').src = photoUrl;

    } else {
      alert("Failed to load profile: " + (data.error || data.message));
    }
  } catch (err) {
    alert("Network error: " + err.message);
  }
}
  async function updateProfile() {
  try {
    const formData = new FormData();
    formData.append("name", document.getElementById("pName").value);
    formData.append("phone", document.getElementById("pPhone").value);
    formData.append("address", document.getElementById("pLocation").value);


    const photoFile = document.getElementById("pPhotoFile").files[0];
    if (photoFile) {
      formData.append("photo", photoFile);
    } else {
      formData.append("photo", document.getElementById("pPhoto").value);
    }

    const res = await fetch(`http://localhost:3000/api/passenger/${encodeURIComponent(email)}`, {
      method: "PATCH",
      headers: { 'Authorization': `Bearer ${token}` },
      body: formData
    });

    // Check status before parsing
    if (res.ok) {
      // Try to parse JSON, but safely
      const data = await res.json().catch(() => null);
      alert("Profile updated successfully!");
      fetchProfile();
    } else {
      // Not ok, try to get JSON error or fallback to text
      let errorMessage;
      try {
        const err = await res.json();
        errorMessage = err.message || JSON.stringify(err);
      } catch {
        errorMessage = await res.text();
      }
      alert("Error: " + errorMessage);
    }
  } catch (error) {
    alert("Error: " + error.message);
  }
}


  function logout() {
    localStorage.clear();
    window.location.href = "/front-end/login.html";
  }

  function goToBargaining() {
    const from = document.getElementById('selectFrom').value;
    const to = document.getElementById('selectTo').value;
    const date = document.getElementById("rideDate").value;
    const time = document.getElementById("rideTime").value;

    const params = new URLSearchParams({ from, to, date, time }).toString();
    window.location.href = `/front-end/bargenning.html?${params}`;
  }

  function setMinDateTime() {
    const dateInput = document.getElementById('rideDate');
    const timeInput = document.getElementById('rideTime');

    const now = new Date();
    const todayDateStr = now.toISOString().split('T')[0];
    const currentTimeStr = now.toTimeString().slice(0, 5);

    dateInput.min = todayDateStr;
    dateInput.value = todayDateStr;
    timeInput.value = currentTimeStr;

    dateInput.addEventListener('change', function () {
      if (this.value === todayDateStr) {
        timeInput.min = currentTimeStr;
        if (timeInput.value < currentTimeStr) {
          timeInput.value = currentTimeStr;
        }
      } else {
        timeInput.removeAttribute('min');
      }
    });
  }

  window.onload = () => {
    setMinDateTime();
    fetchProfile();
  };
</script>

</body>
</html>
